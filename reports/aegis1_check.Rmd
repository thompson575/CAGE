---
title: 'CAGE: Check AEGIS1 ANALYSIS'
author: "John Thompson"
date: "2023-02-17"
output: 
  html_document:
    theme: cerulean
---

```{r setup, include=FALSE}
library(tidyverse)
library(glue)

home <- "C:/Projects/RCourse/Masterclass/CAGE"

# -------------------------------------------------
# dependencies - input files used by this script
#
file_EXN <- file.path(home, "data/cache/expression.rds")
file_PAT <- file.path(home, "data/cache/patients.rds")
file_DFN <- file.path(home, "code/display_functions.R")
file_EA1 <- file.path(home, "data/cache/expression_aegis1.rds")
file_EA2 <- file.path(home, "data/cache/expression_aegis2.rds")
file_VPC <- file.path(home, "data/cache/aegis1_vpca.rds")
file_VS1 <- file.path(home, "data/cache/aegis1_vpca_scores.rds")
file_VS2 <- file.path(home, "data/cache/aegis2_vpca_scores.rds")
file_CPC <- file.path(home, "data/cache/aegis1_cpca.rds")
file_CS1 <- file.path(home, "data/cache/aegis1_cpca_scores.rds")
file_CS2 <- file.path(home, "data/cache/aegis2_cpca_scores.rds")
file_LS1 <- file.path(home, "data/cache/aegis1_loss.rds")
file_LGF <- file.path(home, "data/cache/aegis1_log.txt")

source(file_DFN)


knitr::opts_chunk$set(echo = TRUE, 
                      fig.align = "center",
                      message=FALSE)

readRDS(file_PAT) %>%
  mutate(class = ifelse(diagnosis == "Cancer", 1, 0)) %>% 
  select(id, diagnosis, class) -> classDF
  

readRDS(file_LS1) -> loss
```

## Background

PCA of the 1000 probe subset of the expression data.

## Warning Messages

```{r}
readLines(file_LGF)
```

## Unscaled PCA

```{r}
vpca <- readRDS(file_VPC)

# ---------------------------------------------
# Principal Components Stdev (root eigenvalues)
#
plot_eigenvalues(vpca$sdev) +
  ggtitle("Standard deviatons of the Principal Components")
```

## Unscaled PCA scores training data

```{r}
readRDS(file_VS1) %>%
  print() -> vScoreTrainDF
# ---------------------------------------------
# Illustrative plot of first 5 PCs by diagnosis
# training data
#
glue("PC{1:5}") %>%
  boxplot_features(vScoreTrainDF %>%
                      left_join(classDF, by = "id")) +
  labs(title = "Training data: PCA Scores by diagnosis",
       y     = "Score",
       x     = "Principal Component")
```

## Unscaled PCA scores validation Data

```{r}
readRDS(file_VS2) %>%
  print() -> vScoreValidDF

# ---------------------------------------------
# Illustrative plot of first 5 PCs by diagnosis
# validation data
#
glue("PC{1:5}") %>%
  boxplot_features(vScoreValidDF %>%
                      left_join(classDF, by = "id")) +
  labs(title = "Validation data: PCA Scores by diagnosis",
       y     = "Score",
       x     = "Principal Component")
```

## Scaled PCA

```{r}
cpca <- readRDS(file_CPC)

# ---------------------------------------------
# Principal Components Stdev (root eigenvalues)
#
plot_eigenvalues(cpca$sdev) +
  ggtitle("Standard deviatons of the Principal Components")
```

## Scaled PCA scores training data

```{r}
readRDS(file_CS1) %>%
  print() -> cScoreTrainDF
# ---------------------------------------------
# Illustrative plot of first 5 PCs by diagnosis
# training data
#
glue("PC{1:5}") %>%
  boxplot_features(cScoreTrainDF %>%
                      left_join(classDF, by = "id")) +
  labs(title = "Training data: PCA Scores by diagnosis",
       y     = "Score",
       x     = "Principal Component")
```

## Scaled PCA scores validation Data

```{r}
readRDS(file_CS2) %>%
  print() -> cScoreValidDF

# ---------------------------------------------
# Illustrative plot of first 5 PCs by diagnosis
# validation data
#
glue("PC{1:5}") %>%
  boxplot_features(cScoreValidDF %>%
                      left_join(classDF, by = "id")) +
  labs(title = "Validation data: PCA Scores by diagnosis",
       y     = "Score",
       x     = "Principal Component")
```

## Best Probes

```{r}
loss$probeUniDF %>%
  print() %>%
  arrange(loss) %>%
  print()
```

```{r}
print(loss$probeSelectedDF)
```


## Unscaled PCA: Most Predictive PCs

```{r}
loss$vpcaUniDF %>%
  print() %>%
  arrange(loss) %>%
  print()

loss$vpcaSelectedDF %>%
  print()
```

```{r}
loss$vpcaOrderedDF %>%
  print()
```

## Unscaled PCA: First PCs

```{r}
loss$vpcaOrderedDF %>%
  print()
```

## Scaled PCA: Most Predictive PCs

```{r}
loss$cpcaUniDF %>%
  print() %>%
  arrange(loss) %>%
  print()

loss$cpcaSelectedDF %>%
  print()
```

## Scaled PCA: First PCs

```{r}
loss$cpcaOrderedDF %>%
  print()
```
